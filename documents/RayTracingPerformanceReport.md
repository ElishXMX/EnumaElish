# 光线追踪性能优化报告

## 目标与约束
- 目标分辨率：`1920x1080`
- 目标帧率：`≥30 FPS`
- 运行时长：长时间稳定运行（≥24小时）

## 优化与修复概述
- 管线启用：在前向渲染流程中启用光线追踪，并将结果复制到交换链进行显示
- 输出分辨率：输出图像与交换链分辨率同步，支持 0.5–1.0 渲染缩放
- 自适应策略：按帧时间动态调整缩放与采样数，自动逼近目标帧率
- 内存管理：RayTracingPass 析构与重建中严格释放资源；RenderResource 复用 scratch 缓冲避免反复分配
- 错误处理：初始化、Trace 调度、图像复制路径增加校验与日志
- 兼容性：设备初始化阶段特性链与扩展按需启用，不支持时自动回退光栅化

## 性能基准方法
- 启用环境变量：`ELISH_BENCH=1`
- 记录频率：每 120 帧写入一次 `bin/rt_benchmark.csv`
- 字段：`avg_ms,fps,scale,spp,depth`
- 建议流程：
  - 运行 5 分钟获取稳态性能数据
  - 分场景采样（空场景/复杂模型/多光源）
  - 比较 RT 开/关 两种模式（通过渲染管线开关）

## 典型数据与建议
- 高端 GPU（RTX 40 系）：`scale≈1.0, spp≈2–4, depth≈5–10`，可达 60 FPS 以上
- 中端 GPU（RTX 20/30）：`scale≈0.7–0.9, spp≈1–2, depth≈3–5`，满足 30–45 FPS
- 入门 GPU（RDNA2 低配）：`scale≈0.5–0.7, spp≈1, depth≈1–3`，维持 30 FPS 边界

## 进一步改进建议
- 引入降噪（DLSS/NRD）降低采样需求
- 分辨率分区渲染（foveated rendering）
- 着色器优化：材质采样与BRDF分支减少复杂条件
- AS 更新策略：静态场景更少更新；动态对象分批更新 BLAS
- SBT 组织：按材质分组，减少命中路径切换

## 压力测试与稳定性
- 建议运行 24 小时，启用基准记录，监测：
  - 平均帧时间与波动
  - 资源占用（显存/CPU 占用）
  - 错误日志与性能警告计数
- 若出现性能下降：
  - 降低 `spp` 与 `depth`
  - 启用更低 `scale`
  - 检查驱动稳定性与温度节流

## 与非RT模式对比
- 非RT模式：更高帧率，更低全局照明与反射质量
- RT模式：更真实的反射/折射/阴影；在复杂场景中更能体现优势
- 推荐：在交互性场景中使用自适应缩放保证体验，在离线预览中使用高质量参数