# 天空盒着色器测试和验证指南

## 概述
本文档描述了新编写的天空盒着色器的测试和验证流程，确保着色器在投入生产使用前经过充分验证。

## 新着色器特性

### 主要改进
1. **移除UBO依赖**: 使用推送常量(Push Constants)替代UBO，解决Vulkan验证层错误
2. **简化数据流**: 减少不必要的数据传递，提高性能
3. **标准化接口**: 使用标准的Vulkan 4.5.0规范
4. **优化内存布局**: 减少GPU内存带宽使用

### 技术规格
- **顶点着色器**: `skybox_new.vert`
  - 使用推送常量传递变换矩阵
  - 程序化生成立方体顶点
  - 输出标准化纹理坐标
  
- **片段着色器**: `skybox_new.frag`
  - 简化的立方体贴图采样
  - 标准化纹理坐标处理
  - 可选的色调映射支持

## 验证步骤

### 1. 编译验证
```bash
# 编译新着色器
cmake --build . --target EnumaElishShaderCompile

# 检查编译输出，确保无警告和错误
```

### 2. Vulkan验证层测试
```bash
# 启用Vulkan验证层运行程序
set VK_LAYER_PATH=%VULKAN_SDK%\Bin
set VK_INSTANCE_LAYERS=VK_LAYER_KHRONOS_validation
engine\EnumaElish.exe

# 预期结果：无Vulkan验证层错误
```

### 3. 功能测试清单

#### 基础功能测试
- [ ] 着色器编译成功，无错误和警告
- [ ] Vulkan验证层无错误报告
- [ ] 天空盒正确渲染，无黑屏或花屏
- [ ] 纹理坐标映射正确

#### 视觉质量测试
- [ ] 天空盒在不同视角下显示正确
- [ ] 立方体贴图接缝处无明显瑕疵
- [ ] 颜色和亮度符合预期
- [ ] 深度测试正确（天空盒始终在背景）

#### 性能测试
- [ ] 帧率无明显下降
- [ ] GPU内存使用合理
- [ ] 渲染时间在可接受范围内

#### 兼容性测试
- [ ] 在不同GPU上正常工作
- [ ] 与现有渲染管线兼容
- [ ] 不影响其他渲染通道

### 4. 集成测试

#### 修改CMakeLists.txt
需要将新着色器添加到编译列表中：
```cmake
# 在 engine/runtime/shader/CMakeLists.txt 中添加
set(SHADER_FILES
    # ... 现有着色器 ...
    glsl/skybox_new.vert
    glsl/skybox_new.frag
)
```

#### 更新渲染代码
需要修改天空盒渲染相关的C++代码：
1. 更新描述符集布局（移除UBO，添加推送常量）
2. 修改管线创建代码
3. 更新渲染循环中的数据绑定

### 5. 回归测试
- [ ] 确保现有功能未受影响
- [ ] 验证其他渲染通道正常工作
- [ ] 检查整体渲染质量

## 部署前检查清单

### 代码审查
- [ ] 着色器代码符合项目编码规范
- [ ] 注释完整且准确
- [ ] 无硬编码的魔法数字
- [ ] 错误处理适当

### 文档更新
- [ ] 更新技术文档
- [ ] 记录API变更
- [ ] 更新用户手册（如适用）

### 最终验证
- [ ] 所有测试用例通过
- [ ] 性能指标达标
- [ ] 代码审查完成
- [ ] 文档更新完成

## 已知限制和注意事项

1. **推送常量大小限制**: Vulkan规范要求推送常量至少支持128字节，当前使用约80字节，在安全范围内
2. **纹理格式兼容性**: 确保立方体贴图格式与着色器采样器兼容
3. **深度缓冲**: 天空盒渲染需要正确的深度测试设置

## 故障排除

### 常见问题
1. **黑屏**: 检查纹理绑定和采样器设置
2. **验证层错误**: 确保描述符集布局与着色器匹配
3. **性能问题**: 检查推送常量更新频率

### 调试建议
1. 使用RenderDoc等工具进行GPU调试
2. 启用详细的Vulkan验证层输出
3. 逐步测试各个渲染阶段

## 结论

新的天空盒着色器设计解决了原有的Vulkan验证层错误，同时提供了更好的性能和可维护性。通过遵循本测试指南，可以确保着色器在生产环境中稳定可靠地工作。

**重要提醒**: 在将新着色器集成到主分支之前，必须完成所有测试步骤并确保所有检查项都已通过。